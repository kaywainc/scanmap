<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Scan Map Country</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"></script>
    <style type="text/css">

    body {
    background: #ccc;
    }

    #scanmap_country {
    background: #fff;
    }

    .graticule {
    fill: none;
    stroke: #ccc;
    stroke-opacity: .5;
    stroke-width: .5px;
    }

    .land {
    fill: steelblue;
    }

    .boundary {
    fill: none;
    stroke: #fff;
    stroke-width: .5px;
    }
    .legend {
    font-size: 12px;
    }

    </style>
  </head>
  
  <body>
    <div id="scanmap_country"></div>  
    
    <script type="text/javascript">  

      
      // width and height      (Google Map Size is: 597 x 365 Pixel; 1.63561644)
      var w = 1200; //142, 1059 Measurements from Line Chart
      var h = 470;  // 255, 60 Measurements from Line Chart
      var padding = 20;
     
      var color_domain = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      var color_range = ["rgb(240,240,240)","rgb(230,240,255)", "rgb(178,209,255)", "rgb(128,178,255)", "rgb(78,148,255)", "rgb(0,102,255)", "rgb(0,82,204)", "rgb(0,71,178)", "rgb(0,61,153)", "rgb(0,51,128)", "rgb(0,31,76)"];
      // alternative color_range: ["#f2f0f7", "#dadaeb", "#bcbddc", "#9e9ac8", "#756bb1", "#54278f"]
      

      var color = d3.scale.threshold()
                    .domain(color_domain)
                    .range(color_range);
                  

//       var projection = d3.geo.mercator()
//                          .scale(130) // .scale((w + 1) / 2 / Math.PI)
//                          .translate([(w / 2)-110, (h / 2)+70]) // 110 instead of 142
//                          .precision(.1);
      var projection = d3.geo.larrivee()
                         .scale(130) // .scale((w + 1) / 2 / Math.PI)
                         .translate([(w / 2)-110, (h / 2)+70]) // 110 instead of 142
                         .precision(.1);

      var path = d3.geo.path()
        .projection(projection);

      var graticule = d3.geo.graticule();


      var svg = d3.select("#scanmap_country")
        .append("svg")
        .attr("width", w)
        .attr("height", h)
        .attr("aria-label", "A country map for QR Code Scans");



//Reading map file and data

/*
queue()
  .defer(d3.json, "mapdata/world-50m.json")
  .defer(d3.tsv, "mapdata/world-country_names.tsv")
  .defer(d3.csv, "scandata/country_scans.csv")
  .await(ready);


Start of Choropleth drawing

  function ready(error, map, data) {
  var rateById = {};
  var nameById = {};

  data.forEach(function(d) {
  rateById[d.Country_Code] = +d.Scans;
  nameById[d.Country_Code] = d.Country_Code;
});

//Drawing Choropleth

  svg.append("g")
  .selectAll("path")
  .data(countries)
  .enter().append("path")
  .attr("d", path)
  .style("fill", function(d) {
    return color(rateById[d.properties.region]); 
  });

  };
*/
		var country_names = [];
		d3.tsv("mapdata/world-country-names1.tsv", function(error, country_names_list) {
      if(country_names_list && country_names_list.length > 0)
      {
        $.each(country_names_list, function(index, country){
          country_names[country.id] = country.name;
        }); 
        // console.log(country_names);
      }
		});
    var country_hits = [];
    var max_hits = 0;
      d3.json("scandata/country_hits.json", function(error, world_hits){
        if(world_hits && world_hits.length)
        {
          max_hits = d3.max(world_hits, function(n) {return +n['hits']; });
          
          $.each(world_hits, function(index, world_country_hits){
            country_hits[world_country_hits.country] = world_country_hits.hits;
          });
          // console.log(country_hits);
          // d3.max(country_hits, function(n) { console.log("here i am...",n);  return n.color; });
        }

      });
      d3.json("mapdata/world-50m.json", function(error, world) {
        var countries = topojson.feature(world, world.objects.countries).features,
            neighbors = topojson.neighbors(world.objects.countries.geometries);
        //svg.insert("path", ".graticule")
        //.datum(topojson.feature(world, world.objects.land))
        //.attr("class", "land")
        //.attr("d", path);

		// console.log(countries);
      //Drawing Choropleth
    

      svg.selectAll(".country")
        .data(countries)
        .enter()
        .insert("path", ".graticule")
        .attr("class", "country")
        .attr("id", function(d,i) { return d.id})
        .attr("title", function(d,i) { return country_names[d.id] + " : " + country_hits[country_names[d.id]]})
        .attr("d", path)
        .on('mouseover', function(d,i,e){
			//$('#'+d.id).attr('opacity',0.5);
			$('#'+d.id).attr('stroke',"#AAA");
        	$('#'+d.id).attr('stroke-width',0.5)
        })
        .on("mouseout", function(d, i){
        	$('#'+d.id).attr('opacity',1);
        	$('#'+d.id).attr('stroke',"#AAA");
        	$('#'+d.id).attr('stroke-width',0);
        })
        .style("fill", function(d, i) {
         if(typeof country_hits[country_names[d.id]] === 'undefined')
         {
            country_color = color(0);
         }
         else
         {
            country_color = color(Math.ceil((country_hits[country_names[d.id]]/max_hits)*10));
         }
//          console.log(country_hits[country_names[d.id]], country_names[d.id], i, d,  country_color); 
         // return color_range[Math.ceil(country_hits[country_names[d.id]]/max_hits)];
         return country_color;
       });


      svg.insert("path", ".graticule")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("class", "boundary")
        .attr("d", path);
      });

      d3.select(self.frameElement).style("height", h + "px");


      //Adding legend for our Choropleth
    var ext_color_domain = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    var legend_labels = ["0", "<10%", ">10%", ">20%", ">30%", ">40%", ">50%", ">60%", ">70%", ">80%", ">90%"]

    var legend = svg.selectAll("g.legend")
    .data(ext_color_domain)
    .enter().append("g")
    .attr("class", "legend");

    var ls_w = 20, ls_h = 20;

    legend.append("rect")
    .attr("x", 20)
    .attr("y", function(d, i){ return h - (i*ls_h) - 2*ls_h;})
    .attr("width", ls_w)
    .attr("height", ls_h)
    .style("fill", function(d, i) { return color(d); });
    // .style("opacity", 0.8);

    legend.append("text")
    .attr("x", 50)
    .attr("y", function(d, i){ return h - (i*ls_h) - ls_h - 4;})
    .text(function(d, i){ return legend_labels[i] });
    
    $(document).ready(function(){
	    $('.country').on('mouseover', function(e){
	    	console.log(this);
	    });
    	
    });





    </script>
  </body>
</html>