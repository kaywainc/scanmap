<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Scan Map Country</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"></script>
    <style type="text/css">

    body {
    background: #ccc;
    }

    #scanmap_country {
    background: #fff;
    }

    .graticule {
    fill: none;
    stroke: #ccc;
    stroke-opacity: .5;
    stroke-width: .5px;
    }

    .land {
    fill: steelblue;
    }

    .boundary {
    fill: none;
    stroke: #fff;
    stroke-width: .5px;
    }

    </style>
  </head>
  
  <body>
    HELLO
    <div id="scanmap_country"></div>  
    
    <script type="text/javascript">  

      //Data
      JSONData = [
                 [{"country":"United States","hits":"32938","timestamp":"1355830227"},{"country":"Brazil","hits":"9258","timestamp":"1334210400"},{"country":"United Kingdom","hits":"5579","timestamp":"1343959200"},{"country":"Germany","hits":"5317","timestamp":"1336388400"},{"country":"Canada","hits":"4210","timestamp":"1348952400"},{"country":"Russian Federation","hits":"4207","timestamp":"1356265533"},{"country":"India","hits":"3988","timestamp":"1355727256"},{"country":"Thailand","hits":"3469","timestamp":"1366826915"},{"country":"Taiwan","hits":"2985","timestamp":"1375947991"},{"country":"Italy","hits":"2848","timestamp":"1355749324"},{"country":"France","hits":"2791","timestamp":"1358002457"},{"country":"Mexico","hits":"2610","timestamp":"1355770260"},{"country":"Australia","hits":"2478","timestamp":"1372096008"},{"country":"Saudi Arabia","hits":"2008","timestamp":"1334476800"},{"country":"Spain","hits":"1936","timestamp":"1334242800"},{"country":"Turkey","hits":"1860","timestamp":"1364964644"},{"country":"Poland","hits":"1855","timestamp":"1334354400"},{"country":"Iran, Islamic Republic of","hits":"1827","timestamp":"1345600800"},{"country":"Czech Republic","hits":"1648","timestamp":"1390554261"},{"country":"China","hits":"1611","timestamp":"1359315982"},{"country":"Switzerland","hits":"1562","timestamp":"1335092400"},{"country":"Netherlands","hits":"1560","timestamp":"1369288786"},{"country":"Vietnam","hits":"1542","timestamp":"1355732509"},{"country":"Hong Kong","hits":"1537","timestamp":"1334192400"},{"country":"Ukraine","hits":"1450","timestamp":"1337263200"},{"country":"Malaysia","hits":"1295","timestamp":"1353603600"},{"country":"Portugal","hits":"1289","timestamp":"1355747180"},{"country":"Serbia","hits":"1273","timestamp":"1333454400"},{"country":"Israel","hits":"1238","timestamp":"1355723369"},{"country":"Indonesia","hits":"1152","timestamp":"1358651980"},{"country":"Sweden","hits":"1042","timestamp":"1355737889"}];

      var data = JSONData.slice();
      var hits = function(d) { return Number(d.hits); }
      var country = function(d) {return d.country; }
      var date = function(d) { return new Date(d.timestamp * 1000); }
        
      
      // width and height      (Google Map Size is: 597 x 365 Pixel; 1.63561644)
      var w = 1200; //142, 1059 Measurements from Line Chart
      var h = 470;  // 255, 60 Measurements from Line Chart
      var padding = 20;
     
      var color_domain = [0, d3.max(data, hits)]
      var color_range = ["rgb(247,251,255)", "rgb(222,235,247)", "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)", "rgb(66,146,198)", "rgb(33,113,181)", "rgb(8,81,156)", "rgb(8,48,107)"]
      // alternative color_range: ["#f2f0f7", "#dadaeb", "#bcbddc", "#9e9ac8", "#756bb1", "#54278f"]

      var color = d3.scale.threshold()
                    .domain(color_domain)
                    .range(color_range);
                  

      var projection = d3.geo.mercator()
                         .scale(130) // .scale((w + 1) / 2 / Math.PI)
                         .translate([(w / 2)-110, (h / 2)+70]) // 110 instead of 142
                         .precision(.1);

      var path = d3.geo.path()
        .projection(projection);

      var graticule = d3.geo.graticule();


      var svg = d3.select("#scanmap_country")
        .append("svg")
        .attr("width", w)
        .attr("height", h)
        .attr("aria-label", "A country map for QR Code Scans");



//Reading map file and data

/*
queue()
  .defer(d3.json, "mapdata/world-50m.json")
  .defer(d3.tsv, "mapdata/world-country_names.tsv")
  .defer(d3.csv, "scandata/country_scans.csv")
  .await(ready);


Start of Choropleth drawing

  function ready(error, map, data) {
  var rateById = {};
  var nameById = {};

  data.forEach(function(d) {
  rateById[d.Country_Code] = +d.Scans;
  nameById[d.Country_Code] = d.Country_Code;
});

//Drawing Choropleth

  svg.append("g")
  .selectAll("path")
  .data(countries)
  .enter().append("path")
  .attr("d", path)
  .style("fill", function(d) {
    return color(rateById[d.properties.region]); 
  });

  };
*/
		var country_names = [];
		d3.tsv("mapdata/world-country-names.tsv", function(error, country_names_list) {
			$.each(country_names_list, function(index, country){
			 country_names[country.id] = country.name;
			});
			// console.table(country_names)
		});
      d3.json("mapdata/world-50m.json", function(error, world) {
        var countries = topojson.feature(world, world.objects.countries).features,
            neighbors = topojson.neighbors(world.objects.countries.geometries);
        //svg.insert("path", ".graticule")
        //.datum(topojson.feature(world, world.objects.land))
        //.attr("class", "land")
        //.attr("d", path);

		console.log(countries);
      //Drawing Choropleth

      svg.selectAll(".country")
        .data(countries)
        .enter()
        .insert("path", ".graticule")
        .attr("class", "country")
        .attr("id", function(d,i) { return d.id})
        .attr("title", function(d,i) { return country_names[d.id]})
        .attr("d", path)
        .style("fill", function(d, i) { return color(d.color = d3.max(neighbors[i], function(n) { return countries[n].color; }) + 1 | 0); });


      svg.insert("path", ".graticule")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
        .attr("class", "boundary")
        .attr("d", path);
      });

      d3.select(self.frameElement).style("height", h + "px");




    </script>
  </body>
</html>