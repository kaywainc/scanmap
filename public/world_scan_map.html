<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>World Scan Map</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/queue.v1.min.js"></script>
    <script type="text/javascript" src="http://d3js.org/topojson.v1.min.js"></script>
    <style type="text/css">

    body {
    background: #ccc;
    font-family: Arial, sans-serif;
    }

    #scanmap_country {
    background: #fff;
    }

    .graticule {
    fill: none;
    stroke: #ccc;
    stroke-opacity: .5;
    stroke-width: .5px;
    }
   
    .land {
    fill: #eff3ff;
    }
    
    
    .boundary {
    fill: none;
    /*stroke: #fff;
    stroke-width: .5px;*/
    }


    .legend {
    font-size: 12px;
    }

    </style>
  </head>
  
  <body>
    <div id="scanmap_country"></div>  
    
    <script type="text/javascript">  

      // width and height      (Google Map Size is: 597 x 365 Pixel; 1.63561644)
      var w = 1200; //142, 1059 Measurements from Line Chart
      var h = 470;  // 255, 60 Measurements from Line Chart
      var centered;
      var padding = 20;

     
      //var color_domain = [0, d3.max(data, scans)] 
      var color_domain = [0, d3.max(d.scans)]
      var ext_color_domain = [0, 5, 10, 15, 20, 250]
      var legend_labels = ["0%", "Up to 20%", "21 - 40%", "41 - 60%", "61 - 80%", "81 - 100%"]     
      var color_range = [ "rgb(239,243,255)", "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)",
                          "rgb(49,130,189)", "rgb(8,81,156)"]
      // IN HEX: #eff3ff, #c6dbef, #9ecae1, #6baed6, #3182bd, #08519c
      // From http://colorbrewer2.org/
      
      // Alternative Color Range with more colors: "rgb(247,251,255)", "rgb(222,235,247)", "rgb(198,219,239)", 
      // "rgb(158,202,225)", "rgb(158,202,225)" , "rgb(107,174,214)", "rgb(66,146,198)", "rgb(33,113,181)", 
      // "rgb(8,81,156)", "rgb(8,48,//107)"]

      var color = d3.scale.quantize()
                    .domain([0, 30])
                    .range(color_range);
                  

      var projection = d3.geo.mercator()
                         .scale(130) // .scale((w + 1) / 2 / Math.PI)
                         .translate([(w / 2)-110, (h / 2)+70]) // 110 instead of 142
                         .precision(.1);

      var path = d3.geo.path()
                   .projection(projection);

      var graticule = d3.geo.graticule();

      var svg = d3.select("#scanmap_country")
        .append("svg")
        .attr("width", w)
        .attr("height", h)
        .attr("aria-label", "A country map for QR Code Scans");


      queue()
        .defer(d3.json, "mapdata/world-50m.json")
        .defer(d3.csv, "scandata/country_scans.csv")
        .await(ready);

      var g = svg.append("g");

      function ready(error, world, scans) {
        var scansById = {}; 

      scans.forEach(function(d) { scansById[d.id] = +d.scans; }); // +d.scans => the + converts to a number      

      g.append("g")
        .attr("class", "land")
        .selectAll("path")
        .data(topojson.feature(world, world.objects.countries).features)
        .enter()
        .append("path")
        .attr("d", path)
        .style("fill", function(d) { return color(scansById[d.id]); })
        .on("click", clicked); // Zoom in function

      svg.append("path")
        .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a.id !== b.id; }))
        .attr("class", "boundary")
        .attr("d", path);
      };

      //Adding the legend for our Choropleth

      var legend = svg.selectAll("g.legend")
        .data(ext_color_domain)
        .enter()
        .append("g")
        .attr("class", "legend");

      var ls_w = 20, ls_h = 20;

      legend.append("rect")
        .attr("x", 20)
        .attr("y", function(d, i){ return h - (i*ls_h) - 2*ls_h;})
        .attr("width", ls_w)
        .attr("height", ls_h)
        .style("fill", function(d, i) { return color(d); })
        .style("opacity", 0.8);

      legend.append("text")
        .attr("x", 50)
        .attr("y", function(d, i){ return h - (i*ls_h) - ls_h - 4;})
        .text(function(d, i){ return legend_labels[i]; });


      // Zoom in function
      function clicked(d) {
        var x, y, k;

      if (d && centered !== d) {
        var centroid = path.centroid(d);
        x = centroid[0];
        y = centroid[1];
        k = 4;
        centered = d;
      } else {
        x = w / 2;
        y = h / 2;
        k = 1;
        centered = null;
      }

      g.selectAll("path")
        .classed("active", centered && function(d) { return d === centered; });

      g.transition()
        .duration(750)
        .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
        .style("stroke-width", 1.5 / k + "px"); 
      } 


    </script>
  </body>
</html>